getwd()
list()
sum(1:4)
4*5/2
jose
jose manuel anburt
ana ceci campos paras
setwd("C:/Users/jmaburto/Documents/GitHub/DecompMex/DecompMex")
load('Data/Counts&Rates_1990-2015Mex.RData')
#Groups used in the article:
# 1. Amenable to meical service: 1+2+3+4+6
# 2. Diabetes: 5
# 3. IHD:7
# 4. HIV:8
# 5. Lung cancer: 10
# 6. Cirrhosis: 11
# 7. Homicide: 12
# 8. Road traffic: 13
# 9. Suicide: 9
# 10. All other causes: 14+15+16
#group accordingly
Counts <- Data_Counts[,1:4]
Counts <- cbind(Counts, g1=rowSums(Data_Counts[, c(6,7,8,9,11)]))
Counts <- cbind(Counts, g2=Data_Counts[,10])
Counts <- cbind(Counts, g3=Data_Counts[,12])
Counts <- cbind(Counts, g4=Data_Counts[,13])
Counts <- cbind(Counts, g5=Data_Counts[,15])
Counts <- cbind(Counts, g6=Data_Counts[,16])
Counts <- cbind(Counts, g7=Data_Counts[,17])
Counts <- cbind(Counts, g8=Data_Counts[,18])
Counts <- cbind(Counts, g9=Data_Counts[,14])
Counts <- cbind(Counts, g10=rowSums(Data_Counts[,19:21]))
Counts$Pop <- Data_Counts$Pop
Rates <- Data_rates[,c(1:4,21)]
gdata::keep(Counts,Rates, sure = T)
library(data.table)
Counts <- data.table(Counts)
Rates <- data.table(Rates)
# Cause-specific smoothing -----------------------------------------------
#First smooth with Camarda's method. We smooth cause-specific deaths and then constrain to the unsmoothed rates
source("R/Functions.R")
library(reshape2)
library(MortalitySmooth)
causes   <- 5:14
Counts2  <- data.table(cbind(Counts[,1:4,with=F],g1= rowSums(Counts[,5:14,with=F]),Counts[,15,with=F]))
sm.rates <- data.table(as.matrix(Counts)[,1:4])
sm.rates2 <- data.table(as.matrix(Counts2)[,1:4])
#i <- 5
#Dx <- Counts[sex==1 & state ==1 ]
#DX      <- acast(Dx, age~year, value.var = colnames(Counts)[i], fill = 0)
#EX      <- acast(Dx, age~year, value.var = "Pop", fill = 0)
for (i in causes){
Mxs      <- Counts[,sm.chunk(.SD),by=list(state,sex)]
sm.rates[,paste0("g",i-4)] <- Mxs$mxs
print(i)
# cbind(sm.rates,i= Mxs$mxs)
}
#smooth total mortality rates
Counts2$g1[Counts2$Pop == 0] <- 0
Counts2$g1[Counts2$Pop < Counts2$g1] <- Counts2$Pop[Counts2$Pop < Counts2$g1]
i <- 5
Mxs2      <- Counts2[,sm.chunk(.SD),by=list(state,sex)]
plot(Mxs2$mxs[Mxs2$state==1 & Mxs2$sex==1 & Mxs2$year==1990])
sm.rates2[,"Tot"] <- Mxs2$mxs
#Order all datasets
sm.rates <- sm.rates[order(year,sex,state,age)]
sm.rates2  <- sm.rates2[order(year,sex,state,age)]
Rates <- Rates[order(year,sex,state,age)]
#now constrain to original ones
sm.r    <- sm.rates[,5:14,with=F]
sm.tot  <- rowSums(sm.r)
sm.prop <- sm.r/sm.tot
sm.prop2 <- sm.prop*Rates$total
smooth.rates <- cbind(as.matrix(Rates)[,1:4],mx=rowSums(sm.prop2),sm.prop2)
smooth.rates <- as.data.table(smooth.rates)
#now constrain to smoothed ones
sm.prop3 <- sm.prop*sm.rates2$Tot
smooth.rates2 <- cbind(as.matrix(Rates)[,1:4],mx=rowSums(sm.prop3),sm.prop3)
smooth.rates2 <- as.data.table(smooth.rates2)
#wihout constrain in smoothing by cause
sm.rates$mx <- sm.tot
colnames(sm.rates)
setcolorder(sm.rates,c("year","sex","state","age","mx","g1","g2","g3","g4","g5","g6","g7","g8","g9","g10"))
head(sm.rates)
# This file contains smooth rates constraint to the original ones
save(smooth.rates,file = "Data/smoothed rates_ConstraintOrig.RData")
save(smooth.rates2,file = "Data/smoothed rates_ConstraintSmooth.RData")
# This file contains smooth rates NOT constraint to the original ones
save(sm.rates,file = "Data/smoothed rates_No Constraint.RData")
setwd("C:/Users/jmaburto/Documents/GitHub/DecompMex/DecompMex")
source("R/Functions.R")
library(data.table)
library(reshape2)
data       <- local(get(load("Data/smoothed rates_ConstraintSmooth.RData")))
Mxsc       <- data[,-c(5),with=F]
Mxsc       <- melt.data.table(Mxsc,id.vars = 1:4,variable.name = "cause",value.name = "mx")
Mxscmin    <- Mxsc[,min(mx), by = list(year, sex, age, cause)]
Mxsmin     <- Mxscmin[,sum(V1),by=list(year, sex, age)]
setnames(Mxsmin,4,"mx_min")
# object with minimum death rates for every year by sex and age
head(Mxsmin)
#######################################
# now get best practive lx and Lx, don't really need BP e0
#BPe0 <- Mxsmin[,myLT(mx_min, sex), by = list(year,sex)]
BPlx <- Mxsmin[,lx:=myLTlx(mx_min, sex), by = list(year,sex)]
BPlx[,Lx:=lx2Lx(lx),by = list(year,sex)]
# get temp e0 for BP
bpe0_14       <- BPlx[,getTempe0(.SD),by=list(year, sex)]
bpe0_14$state <- 33
bpe0_14$age.g <- 1
bpe15_39 <- BPlx[,getTempe0(.SD,15,39),by=list(year, sex)]
bpe15_39$state <- 33
bpe15_39$age.g <- 2
bpe40_74 <- BPlx[,getTempe0(.SD,40,74),by=list(year, sex)]
bpe40_74$state <- 33
bpe40_74$age.g <- 3
BP_temp <- rbind(bpe0_14,bpe15_39,bpe40_74)
setnames(BP_temp,"V1","temp_e0")
#######################################
# now do calcs for states
#######################################
#gdata:: keep(Mxsc,data,BP_temp,sure=T)
Mxs         <- data[,1:5,with=F]
Stateslx    <- Mxs[,lx:=myLTlx(mx, sex), by = list(state,year, sex)]
Stateslx    <- Stateslx[,Lx := lx2Lx(lx), by = list(state,year, sex)]
head(Stateslx)
# now get temp e0 for states
ste0_14     <- Stateslx[,getTempe0(.SD,lowera = 0, uppera = 14),by=list(state,year, sex)]
ste0_14$age.g <-1
ste15_39    <- Stateslx[,getTempe0(.SD,lowera=15,uppera=39),by=list(state,year, sex)]
ste15_39$age.g <-2
ste40_74    <- Stateslx[,getTempe0(.SD,lowera=40,uppera=74),by=list(state,year, sex)]
ste40_74$age.g <-3
ste_temp <- rbind(ste0_14,ste15_39,ste40_74)
setnames(ste_temp,"V1","temp_e0")
head(ste_temp)
####### Now find vanguard temporary life expectancy
van_temp <- ste_temp[,max(temp_e0), by = list(year,sex,age.g)]
van_temp$state <- 34
setnames(van_temp,"V1","temp_e0")
head(van_temp)
#### create an object with all temp data
temp.data <- rbind(BP_temp,ste_temp,van_temp)
temp.data <- temp.data[order(year,sex,state,age.g)]
save(data,temp.data,Mxsc,file = "Data/Temp_e0_results.RData")
library(latticeExtra)
library(data.table)
load("Data/Temp_e0_results.RData")
source("R/Functions_fig.R")
fig1.data <- temp.data
fig1.data$age.g <- factor(fig1.data$age.g,levels = 1:3, labels = c("Young (0-14)","Young adults (15-39)","Older adults (40-74)"))
fig1.data$sex<- factor(fig1.data$sex,levels = 1:2, labels = c("Males","Females"))
Fig1 <- useOuterStrips(xyplot(temp_e0 ~ year|age.g+sex,groups = state,data = fig1.data,type="l",
col= c(rep(makeTransparent("black",alpha=65),32),"blue","red"),lwd=2,between=list(x=1,y=1),
key=list(space="bottom",background="transparent",text=list(c('State','Record holder','Low benchmark'),
col="black"),cex=1,lines=list(lty=1,lwd=2,col=c("black","red","blue"))),
xlab="",ylab = "Temporary life expectancy",par.settings=my.settings,par.strip.text=list(cex=1.3),
scales = list(alternating=1,x=list(cex=.9,at=c(seq(1990,2015,5))),y = list(relation = "free",cex=.9),tck=c(1,0)),
ylim = list(range(pretty(fig1.data[fig1.data$age.g=="Young (0-14)"]$temp_e0)),
range(pretty(fig1.data[fig1.data$age.g=="Young adults (15-39)"]$temp_e0)),
range(pretty(fig1.data[fig1.data$age.g=="Older adults (40-74)"]$temp_e0))),
panel = function(x, y, ...){
panel.abline(v=c(seq(1990,2015,5)),col='dark grey',lty=3)
panel.xyplot(x, y,lty=1,...)
}),strip.left = T)
Fig1
