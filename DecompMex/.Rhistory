rm(list=ls(all=TRUE))
if (system("hostname",intern=TRUE) == "ADM-108625") {
setwd("C:/Users/jmaburto/Documents/GitHub/DecompMex/DecompMex")
} else {
if (system("hostname",intern=TRUE) %in% c("triffe-N80Vm", "tim-ThinkPad-L440")){
# if I'm on the laptop
setwd("/home/tim/git/DecompMex/DecompMex")
} else {
# in that case I'm on Berkeley system, and other people in the dept can run this too
setwd(paste0("/data/commons/",system("whoami",intern=TRUE),"/git/DecompMex/DecompMex"))
}}
library(data.table)
library(MortalitySmooth)
library(reshape2)
load('Data/Counts&Rates_1990-2015Mex.RData')
Counts <- Data_Counts[,1:4,with=F]
Counts$g1 <- rowSums(Data_Counts[, c(6,7,8,9,11),with=F])
Counts$g2 <- Data_Counts[,10,with=F]
Counts$g3 <- Data_Counts[,12,with=F]
Counts$g4 <- Data_Counts[,13,with=F]
Counts$g5 <- Data_Counts[,15,with=F]
Counts$g6 <- Data_Counts[,16,with=F]
Counts$g7 <- Data_Counts[,17,with=F]
Counts$g8 <- Data_Counts[,18,with=F]
Counts$g9 <- Data_Counts[,14,with=F]
Counts$g10 <- rowSums(Data_Counts[,19:21,with=F])
Counts$g11 <- rowSums(Counts[,5:14,with=F])
Counts$Pop <- Data_Counts$Pop
# sum(colSums(Counts)[5:15])/2
Rates <- Data_rates[,c(1:4,22),with=F]
gdata::keep(Counts,Rates, sure = T)
Counts <- data.table(Counts)
Rates <- data.table(Rates)
sm.mat.2   <- function(DX, EX){
ages  		<- 0:109
years 		<- 1990:2015
W     		<- EX
W[W > 0] 	<- 1
W[DX < 1 & W == 1] 	<- .3
#W[DX == 0] 	<- 0
mxs         <- W * 0
for (i in 1:ncol(mxs)){
fiti   	<- Mort1Dsmooth(
x = ages,
y = DX[,i],
offset = log(EX[,i]),
W = W[,i],
control=list(MAX.IT=300))
mxsi 	<- exp(fit$logmortality)
mxs[,i] <- mxsi
}
mxs <- melt(mxs, varnames=c("age","year"), value.name = "mxs")
mxs
}
sm.chunk.2 <- function(.SD,i){
DX      <- acast(.SD, age~year, value.var = colnames(Counts)[i], fill = 0)
EX      <- acast(.SD, age~year, value.var = "Pop", fill = 0)
mxs     <- sm.mat.2(DX,EX)
.SD$mxs <- mxs$mxs
# still need to normalize exposure?
.SD
}
Counts[Pop < g11]$g1  <- Counts[Pop < g11]$g2 <- Counts[Pop < g11]$g3 <- Counts[Pop < g11]$g4 <- Counts[Pop < g11]$g5 <- Counts[Pop < g11]$g6 <- Counts[Pop < g11]$g7 <- Counts[Pop < g11]$g8 <- Counts[Pop < g11]$g9 <- Counts[Pop < g11]$g10 <- 0
Counts[Pop < g11]$g11 <- Counts[Pop < g11]$Pop
Rates[total > 1]$total <- 1
source("R/Functions.R")
causes   	<- 5:15
Counts2  	<- data.table(cbind(Counts[,1:4,with=F],g1=Counts$g11,Counts$Pop))
sm.rates 	<- data.table(as.matrix(Counts)[,1:4])
sm.rates2 	<- data.table(as.matrix(Counts2)[,1:4])
sm.rates2  	<- sm.rates2[with(sm.rates2,order(year,sex,state,age)),]
sm.rates  	<- sm.rates[with(sm.rates,order(year,sex,state,age)),]
# TR: 29-3-2017 make new copy to put in the 1-d smoothed rates.
# Smooth over age, but not over period.
sm.rates.age.only <- sm.rates
for (i in causes){
Mxs      <- Counts[,sm.chunk(.SD,i),by=list(state,sex)]
Mxs      <- Mxs[with(Mxs,order(year,sex,state,age)),]
sm.rates[,paste0("g",i-4)] <- Mxs$mxs
print(i)
# cbind(sm.rates,i= Mxs$mxs)
}
# TR: 29-3-2017
# and for period-only smoothing:
for (i in causes){
Mxs      <- Counts[,sm.chunk.2(.SD,i),by=list(state,sex)]
Mxs      <- Mxs[with(Mxs,order(year,sex,state,age)),]
sm.rates.age.only[,paste0("g",i-4)] <- Mxs$mxs
print(i)
# cbind(sm.rates,i= Mxs$mxs)
}
sm.mat.2   <- function(DX, EX){
ages  		<- 0:109
years 		<- 1990:2015
W     		<- EX
W[W > 0] 	<- 1
W[DX < 1 & W == 1] 	<- .3
mxs         <- W * 0
for (i in 1:ncol(mxs)){
fiti   	<- Mort1Dsmooth(
x = ages,
y = DX[,i],
offset = log(EX[,i]),
w = W[,i],
control=list(MAX.IT=300))
mxsi 	<- exp(fit$logmortality)
mxs[,i] <- mxsi
}
mxs <- melt(mxs, varnames=c("age","year"), value.name = "mxs")
mxs
}
sm.chunk.2 <- function(.SD,i){
DX      <- acast(.SD, age~year, value.var = colnames(Counts)[i], fill = 0)
EX      <- acast(.SD, age~year, value.var = "Pop", fill = 0)
mxs     <- sm.mat.2(DX,EX)
.SD$mxs <- mxs$mxs
# still need to normalize exposure?
.SD
}
for (i in causes){
Mxs      <- Counts[,sm.chunk.2(.SD,i),by=list(state,sex)]
Mxs      <- Mxs[with(Mxs,order(year,sex,state,age)),]
sm.rates.age.only[,paste0("g",i-4)] <- Mxs$mxs
print(i)
# cbind(sm.rates,i= Mxs$mxs)
}
for (i in causes){
Mxs      <- Counts[,sm.chunk.2(.SD,i),by=list(state,sex)]
Mxs      <- Mxs[with(Mxs,order(year,sex,state,age)),]
sm.rates.age.only[,paste0("g",i-4)] <- Mxs$mxs
print(i)
# cbind(sm.rates,i= Mxs$mxs)
}
sm.mat.2   <- function(DX, EX){
ages  		<- 0:109
years 		<- 1990:2015
W     		<- EX
W[W > 0] 	<- 1
W[DX < 1 & W == 1] 	<- .3
mxs         <- W * 0
for (i in 1:ncol(mxs)){
fiti   	<- Mort1Dsmooth(
x = ages,
y = DX[,i],
offset = log(EX[,i]),
w = W[,i],
control=list(MAX.IT=300))
mxsi 	<- exp(fit$logmortality)
mxs[,i] <- mxsi
}
mxs <- melt(mxs, varnames=c("age","year"), value.name = "mxs")
mxs
}
sm.chunk.2 <- function(.SD,i){
DX      <- acast(.SD, age~year, value.var = colnames(Counts)[i], fill = 0)
EX      <- acast(.SD, age~year, value.var = "Pop", fill = 0)
mxs     <- sm.mat.2(DX,EX)
.SD$mxs <- mxs$mxs
# still need to normalize exposure?
.SD
}
for (i in causes){
Mxs      <- Counts[,sm.chunk.2(.SD,i),by=list(state,sex)]
Mxs      <- Mxs[with(Mxs,order(year,sex,state,age)),]
sm.rates.age.only[,paste0("g",i-4)] <- Mxs$mxs
print(i)
# cbind(sm.rates,i= Mxs$mxs)
}
sm.mat.2   <- function(DX, EX){
ages  		<- 0:109
years 		<- 1990:2015
W     		<- EX
W[W > 0] 	<- 1
W[DX < 1 & W == 1] 	<- .3
mxs         <- W * 0
for (i in 1:ncol(mxs)){
fiti   	<- Mort1Dsmooth(
x = ages,
y = DX[,i],
offset = log(EX[,i]),
w = W[,i],
control=list(MAX.IT=200))
mxsi 	<- exp(fit$logmortality)
mxs[,i] <- mxsi
}
mxs <- melt(mxs, varnames=c("age","year"), value.name = "mxs")
mxs
}
sm.chunk.2 <- function(.SD,i){
DX      <- acast(.SD, age~year, value.var = colnames(Counts)[i], fill = 0)
EX      <- acast(.SD, age~year, value.var = "Pop", fill = 0)
mxs     <- sm.mat.2(DX,EX)
.SD$mxs <- mxs$mxs
# still need to normalize exposure?
.SD
}
for (i in causes){
Mxs      <- Counts[,sm.chunk.2(.SD,i),by=list(state,sex)]
Mxs      <- Mxs[with(Mxs,order(year,sex,state,age)),]
sm.rates.age.only[,paste0("g",i-4)] <- Mxs$mxs
print(i)
# cbind(sm.rates,i= Mxs$mxs)
}
